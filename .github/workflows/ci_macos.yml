name: Build and Test on Macos

on:
  push:
    branches: [ ci_mac_flow ]
  pull_request:
    branches: [ ci_mac_flow ]

env:
  proc_num: $(sysctl -n hw.logicalcpu)

jobs:
  clang-compile-with-make:
    runs-on: macos-latest # https://github.com/actions/runner-images

    steps:
    - uses: actions/checkout@v2
    
    - name: intall dependences
      run: |
           brew install openssl gnu-getopt coreutils gflags protobuf leveldb

    - name: config_brpc
      run: |
           GETOPT_PATH=$(find "/usr/local/Cellar/" -name "getopt" -type f -perm +111 -exec dirname {} \;)
           export PATH=$GETOPT_PATH:$PATH
           ./config_brpc.sh --header="/usr/local/include" --libs="/usr/local/lib"

    - name: compile
      run: |
           make -j ${{env.proc_num}}

  clang-compile-with-cmake:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v2
    
    - name: intall dependences
      run: |
           brew install openssl gnu-getopt coreutils gflags protobuf leveldb

    - name: cmake
      run: |
           mkdir build
           cd build
           cmake ..

    - name: compile
      run: |
           cd build
           make -j ${{env.proc_num}}

  clang-compile-with-bazel:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v2
    
    - name: intall dependences
      run: |
           brew install openssl gnu-getopt coreutils gflags protobuf leveldb

    - name: compile
      run: |
           bazel build -j ${{env.proc_num}} -c opt --copt -DHAVE_ZLIB=1 //...

  clang-unittest:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v2
    
    - name: intall dependences
      run: |
           brew install openssl gnu-getopt coreutils gflags protobuf leveldb googletest

    - name: config_brpc
      run: |
           GETOPT_PATH=$(find "/usr/local/Cellar/" -name "getopt" -type f -perm +111 -exec dirname {} \;)
           export PATH=$GETOPT_PATH:$PATH
           ./config_brpc.sh --header="/usr/local/include" --libs="/usr/local/lib"

    - name: compile
      run: |
           cd test
           make -j ${{env.proc_num}}

    - name: test
      run: |
           cd test
           sh run_tests.sh

  gcc-compile-with-make:
    runs-on: macos-latest 

    steps:
    - uses: actions/checkout@v2
    
    - name: intall dependences
      run: |
           brew install openssl gnu-getopt coreutils gflags protobuf leveldb

    - name: config_brpc
      run: |
           GETOPT_PATH=$(find "/usr/local/Cellar/" -name "getopt" -type f -perm +111 -exec dirname {} \;)
           export PATH=$GETOPT_PATH:$PATH
           ./config_brpc.sh --header="/usr/local/include" --libs="/usr/local/lib"
      env:
        CC: gcc-10
        CXX: g++-10

    - name: compile
      run: |
           make -j ${{env.proc_num}}

  gcc-compile-with-cmake:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v2
    
    - name: intall dependences
      run: |
           brew install openssl gnu-getopt coreutils gflags protobuf leveldb

    - name: cmake
      run: |
           mkdir build
           cd build
           cmake ..
      env:
        CC: gcc-10
        CXX: g++-10

    - name: compile
      run: |
           cd build
           make -j ${{env.proc_num}}

  gcc-compile-with-bazel:
    runs-on: macos-latest # https://github.com/actions/runner-images

    steps:
    - uses: actions/checkout@v2
    
    - name: intall dependences
      run: |
           brew install openssl gnu-getopt coreutils gflags protobuf leveldb

    - name: compile
      run: |
           bazel build -j ${{env.proc_num}} -c opt --copt -DHAVE_ZLIB=1 //...

  gcc-unittest:
    runs-on: macos-latest # https://github.com/actions/runner-images

    steps:
    - uses: actions/checkout@v2
    
    - name: intall dependences
      run: |
           brew install openssl gnu-getopt coreutils gflags protobuf leveldb googletest

    - name: config_brpc
      run: |
           GETOPT_PATH=$(find "/usr/local/Cellar/" -name "getopt" -type f -perm +111 -exec dirname {} \;)
           export PATH=$GETOPT_PATH:$PATH
           ./config_brpc.sh --header="/usr/local/include" --libs="/usr/local/lib"
      env:
        CC: gcc-10
        CXX: g++-10

    - name: compile
      run: |
           cd test
           make -j ${{env.proc_num}}
      env:
        CC: gcc-10
        CXX: g++-10

    - name: test
      run: |
           cd test
           sh run_tests.sh
      env:
        CC: gcc-10
        CXX: g++-10
